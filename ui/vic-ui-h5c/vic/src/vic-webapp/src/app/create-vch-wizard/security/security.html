<p>
  Define the access to this VCH for management, docker clients and registries. For a basic configuration there is nothing to
  do.
</p>
<ul class="smaller-p-body-text" id="default-security-settings-list">
  <li>A self-signed server certificate will be generated and connections will be encrypted. However, any client can connect with
    authentication.
  </li>
  <li>Only private registries using common CAs will be available to docker clients.</li>
  <li>No restricted operations credentials are used to deploy this Virtual Container Host.</li>
</ul>
<p>
  You can use the advanced options to change this basic configuration.
</p>
<form [formGroup]="form" novalidate>
  <a id="advanced-toggle" class="btn btn-link" (click)="toggleAdvancedMode()">{{ inAdvancedMode ? 'Basic' : 'Advanced' }} <clr-icon [attr.shape]="inAdvancedMode ? 'caret up' : 'caret down'"></clr-icon></a>
  <div *ngIf="inAdvancedMode">
    <div class="alert alert-sm alert-info mb10">
      <div class="alert-item">
        <span class="alert-text">
          The following options will be used for VCH creation only when the advanced mode is open.
        </span>
      </div>
    </div>
    <clr-tabs (clrTabsCurrentTabContentChanged)="clearFileReaderError()">
      <clr-tab-link [clrTabLinkActive]="true">Docker API Access</clr-tab-link>
      <clr-tab-link>Registry Access</clr-tab-link>
      <clr-tab-link>Operations User</clr-tab-link>
      <clr-tab-content [clrTabContentActive]="true">
        <section class="form-block">
          <div class="form-group zero-margin-bottom">
            <label>Use TLS</label>
            <div class="toggle-switch">
              <input type="checkbox" id="use-tls" formControlName="useTls">
              <label for="use-tls">Verify server and encrypt connection</label>
            </div>
          </div>
          <div id="tls-dependent-input-groups" *ngIf="form.get('useTls').value">
            <div class="form-group">
              <label for="tls-cert-path">Path to cerficates folder</label>
              <input size="30" type="text" id="tls-cert-path" formControlName="tlsCertPath">
              <clr-signpost [clrSignpostPosition]="'left-top'">
                <clr-signpost-content *clrIfOpen="signpostOpenState">
                  <span>The local directory where generated certificates are stored or searched</span>
                </clr-signpost-content>
              </clr-signpost>
            </div>
            <div class="p1">Server Certificates</div>
            <div class="form-group zero-margin-bottom">
              <label>Source of certificates</label>
              <div class="radio-inline">
                <input type="radio" value="autogenerated" formControlName="serverCertSource" id="server-autogen">
                <label for="server-autogen">Auto-generate</label>
              </div>
              <div class="radio-inline">
                <input type="radio" value="existing" formControlName="serverCertSource" id="server-existing">
                <label for="server-existing">Existing</label>
              </div>
            </div>
            <!-- sub block for autogenerated server cert -->
            <div *ngIf="form.get('serverCertSource').value === 'autogenerated'" class="margin-vertical-10">
              <span class="margin-vertical-10">
                If an existing server certificate in the certificates folder matches the CommonName and Organization it will be loaded instead of generating a new one.
              </span>
              <div class="form-group zero-margin-bottom">
                <label for="tls-cname">Common Name (CN)</label>
                <input size="30" type="text" id="tls-cname" formControlName="tlsCname">
                <clr-signpost [clrSignpostPosition]="'left-top'">
                  <clr-signpost-content *clrIfOpen="signpostOpenState">
                    <span>An FQDN, IP or wildcard domain that matches all FQDNs in a domain</span>
                  </clr-signpost-content>
                </clr-signpost>
              </div>
              <div class="form-group zero-margin-bottom">
                <label for="organization">Organization (O)</label>
                <input size="30" type="text" id="organization" formControlName="organization">
              </div>
              <div class="form-group zero-margin-bottom">
                <label for="certificate-key-size">Certificate key size</label>
                <input size="30" type="text" id="certificate-key-size" formControlName="certificateKeySize">
              </div>
            </div>
            <!-- sub block for existing server cert -->
            <div *ngIf="form.get('serverCertSource').value === 'existing'">
              <span class="margin-vertical-10">
                You must provide file paths for an existing server certificate and corresponding key.
              </span>
              <div class="alert alert-danger">
                <div class="alert-item">
                  <span class="alert-text">These will be replaced with file upload inputs once API is ready</span>
                </div>
              </div>
              <div class="form-group zero-margin-bottom">
                <label for="tls-server-cert">Server certificate <span class="red-text">*</span></label>
                <input size="30" type="text" id="tls-server-cert" formControlName="tlsServerCert" placeholder="Select X.509 certificate pem file">
              </div>
              <div class="form-group zero-margin-bottom">
                <label for="tls-server-key">Server private key <span class="red-text">*</span></label>
                <input size="30" type="text" id="tls-server-key" formControlName="tlsServerKey" placeholder="Select key pem file">
                <div id="server-key-tooltip"><small>This key must not be encrypted</small></div>
              </div>
            </div>
            <span class="p1 margin-vertical-10">Client Certificates</span>
            <div class="toggle-switch">
              <input type="checkbox" id="use-client-auth" formControlName="useClientAuth">
              <label for="use-client-auth"></label>
            </div>
            <!-- sub block for use client auth -->
            <div *ngIf="form.get('useClientAuth').value">
              <div class="form-group zero-margin-bottom">
                <label>Source of certificates</label>
                <div class="radio-inline">
                  <input type="radio" value="autogenerated" formControlName="clientCertSource" id="client-autogen">
                  <label for="client-autogen">Auto-generate</label>
                </div>
                <div class="radio-inline">
                  <input type="radio" value="existing" formControlName="clientCertSource" id="client-existing">
                  <label for="client-existing">Existing</label>
                </div>
              </div>
              <!-- sub block for existing client cert -->
              <div *ngIf="form.get('clientCertSource').value === 'existing'">
                <span>
                  You can use one or more CA certificates you may have created using some other certificate authority.
                </span>
                <div *ngIf="fileReaderError" class="alert alert-danger">
                  <div class="alert-item">
                    <span class="alert-text">
                      {{ fileReaderError }}
                    </span>
                  </div>
                </div>
                <div [class.p3]="i === 0" formArrayName="tlsCas" *ngFor="let tlsCa of form.controls.tlsCas.controls; let i=index">
                  <div [formGroupName]="i" class="form-group row zero-margin-bottom">
                    <div class="col-xs-3">
                      <div *ngIf="i === 0">Client CAs</div>
                    </div>
                    <div class="col-xs-4">
                      <input id="tls-ca" (change)="addFileContent($event, 'tlsCas', i)" formControlName="tlsCa" class="form-control" type="file">
                    </div>
                    <div class="col-xs-2 input-add-remove-container">
                      <clr-icon shape="times-circle" (click)="removeFormArrayEntry('tlsCas', i)"></clr-icon>
                      <clr-icon *ngIf="i === form.controls.tlsCas.controls.length - 1" shape="plus-circle" (click)="addNewFormArrayEntry('tlsCas')"></clr-icon>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </clr-tab-content>
      <clr-tab-content>
        <section class="form-block">
          <div class="toggle-switch p1">
            <input type="checkbox" id="use-whitelist-registry" formControlName="useWhitelistRegistry">
            <label for="use-whitelist-registry">Whitelist registry mode</label>
          </div>
          <!-- render the following when whitelist mode is used -->
          <div class="zero-margin-bottom" *ngIf="form.get('useWhitelistRegistry').value">
            <p class="margin-vertical-10">
              This VCH can access only those registries in the following whitelist.
            </p>
            <div formArrayName="whitelistRegistries" *ngFor="let whitelistRegistry of form.controls.whitelistRegistries.controls; let i=index">
              <div [formGroupName]="i" class="form-group row zero-margin-bottom">
                <div class="col-xs-3">
                  <div *ngIf="i === 0">Whitelist registries</div>
                </div>
                <div class="col-xs-5">
                  <input type="text" class="form-control" placeholder="IP/FQDN:Port, CIDR or wildcard domain" formControlName="whitelistRegistry">
                </div>
                <div class="col-xs-2">
                  <div class="select">
                    <select formControlName="whitelistRegType">
                      <option value="secure">Secure</option>
                      <option value="insecure">Insecure</option>
                    </select>
                  </div>
                </div>
                <div class="col-xs-2 input-add-remove-container">
                  <clr-icon *ngIf="i > 0" shape="times-circle" (click)="removeFormArrayEntry('whitelistRegistries', i)"></clr-icon>
                  <clr-icon *ngIf="i === form.controls.whitelistRegistries.controls.length - 1" shape="plus-circle" (click)="addNewFormArrayEntry('whitelistRegistries')"></clr-icon>
                </div>
              </div>
            </div>
          </div>
          <!-- render the following when whitelist mode is not used -->
          <div class="zero-margin-bottom" *ngIf="!form.get('useWhitelistRegistry').value">
            <p class="margin-vertical-10">
              This VCH can access all secure registries.
            </p>
            <div class="margin-vertical-10">
              <label>Insecure registry access</label>
              <p class="margin-vertical-10">
                Add registries which this VCH should not verify and access via HTTP if HTTPS fails.
              </p>
              <div formArrayName="insecureRegistries" *ngFor="let insecureRegistry of form.controls.insecureRegistries.controls; let j=index">
                <div [formGroupName]="j" class="form-group row zero-margin-bottom">
                  <div class="col-xs-4">
                    <input type="text" class="form-control" placeholder="IP or FQDN" formControlName="insecureRegistryIp">
                  </div>
                  <div class="col-xs-3">
                    <input type="text" class="form-control" placeholder="Port" formControlName="insecureRegistryPort">
                  </div>
                  <div class="col-xs-2 input-add-remove-container">
                    <clr-icon *ngIf="j > 0" shape="times-circle" (click)="removeFormArrayEntry('insecureRegistries', j)"></clr-icon>
                    <clr-icon *ngIf="j === form.controls.insecureRegistries.controls.length - 1" shape="plus-circle" (click)="addNewFormArrayEntry('insecureRegistries')"></clr-icon>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="margin-vertical-10">
            <label>Additional registry certificates</label>
            <p class="margin-vertical-10">
              Add registry certificates for those registries which need custom or self-signed certificates, like the vSphere Integrated
              Containers Registry.
            </p>
            <div *ngIf="fileReaderError" class="alert alert-danger mb10">
              <div class="alert-item">
                <span class="alert-text">
                  {{ fileReaderError }}
                </span>
              </div>
            </div>
            <div formArrayName="registryCas" *ngFor="let registryCa of form.controls.registryCas.controls; let i=index">
              <div [formGroupName]="i" class="form-group row zero-margin-bottom">
                <div class="col-xs-6">
                  <input type="file" class="form-control" formControlName="registryCa" (change)="addFileContent($event, 'registryCas', i)">
                </div>
                <div class="col-xs-2 input-add-remove-container">
                  <clr-icon shape="times-circle" (click)="removeFormArrayEntry('registryCas', i)"></clr-icon>
                  <clr-icon *ngIf="i === form.controls.registryCas.controls.length - 1" shape="plus-circle" (click)="addNewFormArrayEntry('registryCas')"></clr-icon>
                </div>
              </div>
            </div>
          </div>
        </section>
      </clr-tab-content>
      <clr-tab-content>
        <section class="form-block">
          <p class="margin-vertical-10">
            This VCH will be managed by the vSphere user account that deploys it. You can choose a different vSphere user for deployment
            and operation here.
          </p>
          <div class="form-control row margin-vertical-10">
            <div class="col-xs-4">
              <label for="ops-user">vSphere user account</label>
            </div>
            <div class="col-xs-6">
              <input type="text" id="ops-user" class="form-control" placeholder="vSphere user that deploys VCH" formControlName="opsUser">
            </div>
          </div>
          <span class="smaller-p-body-text margin-vertical-10">
            Note: If you choose to define a user account, you must place the bridge network port group in a network folder that has the Read-Only role with propagation enabled.
          </span>
        </section>
      </clr-tab-content>
    </clr-tabs>
  </div>
</form>
